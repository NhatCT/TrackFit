<!doctype html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/springsecurity6">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title th:text="${pageTitle} ?: 'TrackFit'">TrackFit</title>

  <!-- resources fragment -->
  <th:block th:fragment="resources">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- üî∏ Th∆∞ vi·ªán SockJS/STOMP cho WebSocket -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  </th:block>
</head>

<!-- üî∏ nh√∫ng userId th·∫≠t v√†o attribute ƒë·ªÉ JS l·∫•y -->
<body th:attr="data-user-id=${currentUser != null} ? ${currentUser.userId} : 0">

<nav th:fragment="header" class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand" th:href="@{/}">TrackFit</a>
    <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div id="nav" class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" th:href="@{/dashboard}">Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" th:href="@{/exercises}">B√†i t·∫≠p</a></li>
        <li class="nav-item"><a class="nav-link" th:href="@{/plans}">K·∫ø ho·∫°ch</a></li>
        <li class="nav-item"><a class="nav-link" th:href="@{/users}">Ng∆∞·ªùi d√πng</a></li>
        <li class="nav-item">
          <a class="nav-link text-warning" th:href="@{/stats}" sec:authorize="isAuthenticated()">Th·ªëng k√™</a>
        </li>
      </ul>

      <ul class="navbar-nav">
        <!-- üî∏ M·ª•c Th√¥ng b√°o + badge (ch·ªâ hi·ªán khi ƒë√£ ƒëƒÉng nh·∫≠p) -->
        <li class="nav-item position-relative" sec:authorize="isAuthenticated()">
          <a class="nav-link position-relative" th:href="@{/notifications}">
            Th√¥ng b√°o
            <span id="notif-badge"
                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none">
              0
            </span>
          </a>
        </li>

        <li class="nav-item" sec:authorize="!isAuthenticated()">
          <a class="nav-link" th:href="@{/login}">ƒêƒÉng nh·∫≠p</a>
        </li>
        <li class="nav-item" sec:authorize="isAuthenticated()">
          <form th:action="@{/logout}" method="post" class="d-inline">
            <button class="nav-link btn btn-link text-light p-2">ƒêƒÉng xu·∫•t</button>
          </form>
        </li>
      </ul>
    </div>
  </div>
</nav>

<footer th:fragment="footer" class="bg-light mt-5">
  <div class="container py-4 small text-muted">
    <div class="d-flex justify-content-between">
      <span>TrackFit &copy; 2025</span>
      <span>Built with Spring + Thymeleaf</span>
    </div>
  </div>
</footer>

<!-- helper JS -->
<script>
  function confirmDelete(url) {
    if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a?')) {
      const f = document.createElement('form');
      f.method = 'post';
      f.action = url;
      document.body.appendChild(f);
      f.submit();
    }
  }
</script>

<!-- üî∏ K·∫øt n·ªëi WebSocket v√† subscribe theo userId -->
<script>
(function () {
  // Ch·ªâ b·∫≠t khi ƒë√£ ƒëƒÉng nh·∫≠p (userId > 0)
  const userIdAttr = document.body.getAttribute('data-user-id');
  const userId = Number(userIdAttr || 0);
  if (!Number.isFinite(userId) || userId <= 0) return;

  const baseUrl = window.location.origin + "/TrackFit";   // http://localhost:8080/TrackFit
  const wsEndpoint = baseUrl + "/ws";                     // endpoint b·∫Øt tay
  const badge = document.getElementById("notif-badge");

  function incBadge() {
    if (!badge) return;
    const cur = parseInt(badge.textContent || "0", 10) || 0;
    badge.textContent = String(cur + 1);
    badge.classList.remove("d-none");
  }

  function connectWS() {
    const socket = new SockJS(wsEndpoint);
    const stomp = Stomp.over(socket);
    stomp.debug = () => {}; // t·∫Øt log n·∫øu ·ªìn

    stomp.connect({}, () => {
      const dest = `/topic/notifications.${userId}`;
      stomp.subscribe(dest, (frame) => {
        try {
          const notif = JSON.parse(frame.body);
          console.log("[WS] New notification:", notif);
          incBadge();
          // TODO: hi·ªán toast/append dropdown n·∫øu mu·ªën
        } catch (e) {
          console.error("WS parse error", e);
        }
      });
      console.log("[WS] Subscribed:", dest);
    }, (err) => {
      console.warn("[WS] Error:", err);
      setTimeout(connectWS, 5000); // retry nh·∫π
    });
  }

  connectWS();
})();
</script>

</body>
</html>
